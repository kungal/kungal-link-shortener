generator client {
    provider = "prisma-client-js"
    // output       = "../client"
    // moduleFormat = "esm"
}

datasource db {
    provider = "postgresql"
    url      = env("LINK_DATABASE_URL")
}

model user {
    id            Int       @id @default(autoincrement())
    username      String    @unique @db.VarChar(50)
    password      String    @db.VarChar(255)
    display_name  String    @default("") @db.VarChar(100)
    email         String?   @unique @db.VarChar(255)
    role          Int       @default(1)
    // 0 - normal, 1 - locked
    status        Int       @default(0)
    last_login_ip String    @default("") @db.VarChar(45)
    last_login_at DateTime?
    created       DateTime  @default(now())
    updated       DateTime  @updatedAt

    session    auth_session[]
    short_link short_link[]
}

model auth_session {
    id         Int       @id @default(autoincrement())
    token      String    @unique @db.VarChar(191)
    ip         String    @default("") @db.VarChar(45)
    user_agent String    @default("") @db.VarChar(500)
    expires_at DateTime
    revoked_at DateTime?
    created    DateTime  @default(now())
    updated    DateTime  @updatedAt

    user_id Int
    user    user @relation(fields: [user_id], references: [id], onDelete: Cascade)

    @@index([user_id])
    @@index([user_id, expires_at])
}

model short_link {
    id              Int       @id @default(autoincrement())
    alias           String    @unique @db.VarChar(32)
    destination_url String    @db.Text
    description     String    @default("") @db.VarChar(500)
    // 0 - active, 1 - disabled, 2 - archived
    status          Int       @default(0)
    expires_at      DateTime?
    max_visits      Int       @default(0)
    visit_count     Int       @default(0)
    last_visited_at DateTime?
    access_code     String    @default("") @db.VarChar(64)
    forward_params  Boolean   @default(false)
    created         DateTime  @default(now())
    updated         DateTime  @updatedAt

    user_id Int
    user    user                      @relation(fields: [user_id], references: [id], onDelete: Cascade)
    visit   short_link_visit[]
    bucket  short_link_visit_bucket[]

    @@index([user_id])
    @@index([status])
}

model short_link_visit {
    id         Int      @id @default(autoincrement())
    ip         String   @default("") @db.VarChar(45)
    user_agent String   @default("") @db.VarChar(500)
    referer    String   @default("") @db.VarChar(500)
    country    String   @default("") @db.VarChar(10)
    region     String   @default("") @db.VarChar(50)
    city       String   @default("") @db.VarChar(50)
    device     String   @default("") @db.VarChar(50)
    is_unique  Boolean  @default(false)
    created    DateTime @default(now())

    short_link_id Int
    short_link    short_link @relation(fields: [short_link_id], references: [id], onDelete: Cascade)

    @@index([short_link_id])
    @@index([short_link_id, created])
    @@index([short_link_id, ip])
}

model short_link_visit_bucket {
    id           Int      @id @default(autoincrement())
    bucket_start DateTime
    visits       Int      @default(0)
    unique_ips   Int      @default(0)

    short_link_id Int
    short_link    short_link @relation(fields: [short_link_id], references: [id], onDelete: Cascade)

    created DateTime @default(now())
    updated DateTime @updatedAt

    @@unique([short_link_id, bucket_start])
    @@index([bucket_start])
    @@index([short_link_id, bucket_start])
}
